# Template helper to copy powershell scripts and all dependencies
variables:
-helperLibsPath: $(Build.SourcesDirectory)\src\WinGet.RestSource.PowershellSupport\bin\$(BuildConfiguration)\netstandard2.0

steps:
- task: CopyFiles@2
  displayName: 'Copy Files: Powershell module'
  inputs:
    SourceFolder: '$(build.SourcesDirectory)\Tools\PowershellModule\src'
    TargetFolder: '$(build.artifactstagingdirectory)\Winget.Powershell.Source'
    CleanTargetFolder: true
    OverWrite: true

- task: CopyFiles@2
  displayName: 'Copy Files: Helper Libs x86'
  inputs:
    Contents: |
     $(helperLibsPath)\Microsoft.Extensions.Logging.Abstractions.dll
     $(helperLibsPath)\Microsoft.WinGet.PowershellSupport.dll
     $(helperLibsPath)\Microsoft.WinGet.RestSource.Utils.dll
     $(helperLibsPath)\Newtonsoft.Json.dll
     $(helperLibsPath)\System.ComponentModel.Annotations.dll
     $(helperLibsPath)\YamlDotNet.dll
     $(helperLibsPath)\WinGetUtilInterop.dll
     $(helperLibsPath)\runtimes\win-x86\native\WinGetUtil.dll
    TargetFolder: '$(build.artifactstagingdirectory)\Winget.Powershell.Source\HelperLib\x86'
    OverWrite: true
    flattenFolders: true

- task: CopyFiles@2
  displayName: 'Copy Files: Helper libs x64'
  inputs:
    Contents: |
     $(helperLibsPath)\Microsoft.Extensions.Logging.Abstractions.dll
     $(helperLibsPath)\Microsoft.WinGet.PowershellSupport.dll
     $(helperLibsPath)\Microsoft.WinGet.RestSource.Utils.dll
     $(helperLibsPath)\Newtonsoft.Json.dll
     $(helperLibsPath)\System.ComponentModel.Annotations.dll
     $(helperLibsPath)\YamlDotNet.dll
     $(helperLibsPath)\WinGetUtilInterop.dll
     $(helperLibsPath)\runtimes\win-x64\native\WinGetUtil.dll
    TargetFolder: '$(build.artifactstagingdirectory)\Winget.Powershell.Source\HelperLib\x64'
    OverWrite: true
    flattenFolders: true

- task: CopyFiles@2
  displayName: 'Copy Files: Arm Templates'
  inputs:
    SourceFolder: '$(build.SourcesDirectory)\src\WinGet.RestSource.Infrastructure\bin\$(BuildConfiguration)'
    TargetFolder: '$(build.artifactstagingdirectory)\Winget.Powershell.Source\ARMTemplate'
    OverWrite: true

- task: CopyFiles@2
  displayName: 'Copy Files: azure function'
  inputs:
    SourceFolder: '$(Build.ArtifactStagingDirectory)\WinGet.RestSource.Functions'
    TargetFolder: '$(build.artifactstagingdirectory)\Winget.Powershell.Source\RestAPI'
    OverWrite: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: WinGet.RestSource-Winget.Powershell.Source'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)\Winget.Powershell.Source'
    ArtifactName: 'WinGet.RestSource-Winget.Powershell.Source'
